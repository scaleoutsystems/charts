apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-settings-configmap
data:
  settings.py: |-
    """
    Django settings for studio project.

    Generated by 'django-admin startproject' using Django 2.2.6.

    For more information on this file, see
    https://docs.djangoproject.com/en/2.2/topics/settings/

    For the full list of settings and their values, see
    https://docs.djangoproject.com/en/2.2/ref/settings/
    """

    import os
    import sys
    from pathlib import Path


    AUTHENTICATION_BACKENDS = [
        'django.contrib.auth.backends.ModelBackend',
        'guardian.backends.ObjectPermissionBackend',
    ]

    # JWT settings
    # https://django-rest-framework-simplejwt.readthedocs.io/en/latest/settings.html
    # To generate a new key pair with RS256 algorithm:
    # ssh-keygen -t rsa -b 4096 -m PEM -f jwtRS256.key
    # openssl rsa -in jwtRS256.key -pubout -outform PEM -out jwtRS256.key.pub
    ENABLE_JWT = os.environ.get("ENABLE_JWT", False)
    if ENABLE_JWT:
        SIMPLE_JWT = {
            "ACCESS_TOKEN_LIFETIME": timedelta(minutes=5),
            "REFRESH_TOKEN_LIFETIME": timedelta(days=1),
            "ROTATE_REFRESH_TOKENS": False,
            "BLACKLIST_AFTER_ROTATION": False,
            "UPDATE_LAST_LOGIN": False,

            "ALGORITHM": {{ .Values.studio.jwt_auth.algorithm | quote }},
            "SIGNING_KEY": os.environ.get("SIGNING_KEY", ""),
            "VERIFYING_KEY": os.environ.get("VERIFYING_KEY", ""), 
            "AUDIENCE": None,
            "ISSUER": None,
            "JSON_ENCODER": None,
            "JWK_URL": None,
            "LEEWAY": 0,
            "AUTH_HEADER_TYPES": ("Bearer",),
            "AUTH_HEADER_NAME": "HTTP_AUTHORIZATION",
            "USER_ID_FIELD": "id",
            "USER_ID_CLAIM": "user_id",
            "USER_AUTHENTICATION_RULE": "rest_framework_simplejwt.authentication.default_user_authentication_rule",

            "AUTH_TOKEN_CLASSES": ("rest_framework_simplejwt.tokens.AccessToken",),
            "TOKEN_TYPE_CLAIM": "token_type",
            "TOKEN_USER_CLASS": "rest_framework_simplejwt.models.TokenUser",

            "JTI_CLAIM": "jti",

            "SLIDING_TOKEN_REFRESH_EXP_CLAIM": "refresh_exp",
            "SLIDING_TOKEN_LIFETIME": timedelta(minutes=5),
            "SLIDING_TOKEN_REFRESH_LIFETIME": timedelta(days=1),

            "TOKEN_OBTAIN_SERIALIZER": "rest_framework_simplejwt.serializers.TokenObtainPairSerializer",
            "TOKEN_REFRESH_SERIALIZER": "rest_framework_simplejwt.serializers.TokenRefreshSerializer",
            "TOKEN_VERIFY_SERIALIZER": "rest_framework_simplejwt.serializers.TokenVerifySerializer",
            "TOKEN_BLACKLIST_SERIALIZER": "rest_framework_simplejwt.serializers.TokenBlacklistSerializer",
            "SLIDING_TOKEN_OBTAIN_SERIALIZER": "rest_framework_simplejwt.serializers.TokenObtainSlidingSerializer",
            "SLIDING_TOKEN_REFRESH_SERIALIZER": "rest_framework_simplejwt.serializers.TokenRefreshSlidingSerializer",
        }


    # Build paths inside the project like this: BASE_DIR / 'subdir'.
    BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    # Quick-start development settings - unsuitable for production
    # See https://docs.djangoproject.com/en/2.2/howto/deployment/checklist/

    # SECURITY WARNING: keep the secret key used in production secret!
    SECRET_KEY = os.environ["DJANGO_SECRET"]

    # SECURITY WARNING: don't run with debug turned on in production
    {{ if .Values.studio.debug }}
    DEBUG = True
    {{ else }}
    DEBUG = False
    {{ end }}

    if DEBUG:
        ALLOWED_HOSTS = ['*']
    else:
        ALLOWED_HOSTS = ['{{ .Values.domain }}', '{{ .Release.Name }}-{{ .Values.studio.servicename }}', '{{ .Release.Name }}-studio.{{ .Values.namespace | default "default" }}.svc.{{ .Values.cluster_domain | default "cluster.local"}}']

    # Application definition

    INSTALLED_APPS = [
        'django.contrib.admin',
        'django.contrib.auth',
        'django.contrib.contenttypes',
        'django.contrib.sessions',
        'django.contrib.messages',
        'rest_framework.authtoken',
        'rest_framework',
        'django.contrib.staticfiles',
        'corsheaders',
        'django_extensions',    # for executing runscript among others
        'django_filters',
        'guardian',
        "projects",
        "apps",
        "api",
        "system",
    ]

    {{ if .Values.studio.custom_apps.enabled }}
    CUSTOM_APPS = [{{- range .Values.studio.custom_apps.apps }}{{. | quote }},{{- end }}]
    INSTALLED_APPS = INSTALLED_APPS + CUSTOM_APPS
    {{ end }}

    {{ if .Values.studio.auth_user_model.override }}
    AUTH_USER_MODEL = {{ .Values.studio.auth_user_model.model | quote }}
    {{ end }}


    MIDDLEWARE = [
        'django.middleware.security.SecurityMiddleware',
        'django.contrib.sessions.middleware.SessionMiddleware',
        'django.middleware.common.CommonMiddleware',
        'django.middleware.csrf.CsrfViewMiddleware',
        'django.contrib.auth.middleware.AuthenticationMiddleware',
        'django.contrib.messages.middleware.MessageMiddleware',
        'django.middleware.clickjacking.XFrameOptionsMiddleware',
        'corsheaders.middleware.CorsMiddleware'
    ]

    
    REST_FRAMEWORK = {
        'DEFAULT_AUTHENTICATION_CLASSES': [
            'rest_framework.authentication.TokenAuthentication'
        ],
    }

    # Default primary key field type
    # https://docs.djangoproject.com/en/3.2/ref/settings/#default-auto-field

    #Setting this will remove a warning about CorsModel primary keys filed, however a 
    # permission denied error is introduced
    # when django tries to apply a new migration to corsheaders package. This is because
    # the web server is started as stackn user but the migrations folder in corsheader is root
    # solution for now: setting AutoField as default (below)
    # then setting BigAutoField on app level (ex /projects/apps.py)
    DEFAULT_AUTO_FIELD = "django.db.models.AutoField"

    # Django guardian 403 templates
    GUARDIAN_RENDER_403 = True
    GUARDIAN_TEMPLATE_403 = '403.html'

    # Main Url conf for loading all the routing path in Studio
    ROOT_URLCONF = 'studio.urls'

    # Tagulous serialization settings
    SERIALIZATION_MODULES = {
        'xml':    'tagulous.serializers.xml_serializer',
        'json':   'tagulous.serializers.json',
        'python': 'tagulous.serializers.python',
        'yaml':   'tagulous.serializers.pyyaml',
    }

    STATICFILES_FINDERS = (
        'django.contrib.staticfiles.finders.FileSystemFinder',
        'django.contrib.staticfiles.finders.AppDirectoriesFinder',
        # other finders
        'compressor.finders.CompressorFinder',
    )

    STATIC_URL = '/static/'
    #Use in production and together with Nginx 
    STATIC_ROOT = os.path.join(BASE_DIR, 'static/')
    #STATICFILES_DIRS = ( os.path.join('static'), )


    TEMPLATE_LOADERS = (
        'django.template.loaders.filesystem.Loader',
        'django.template.loaders.app_directories.Loader',
        'django.template.loaders.eggs.Loader',
    )

    TEMPLATES = [
        {
            'BACKEND': 'django.template.backends.django.DjangoTemplates',
            'DIRS': [os.path.join(BASE_DIR, 'templates')],
            'APP_DIRS': True,
            'OPTIONS': {
                'context_processors': [
                    'django.template.context_processors.debug',
                    'django.template.context_processors.request',
                    'django.contrib.auth.context_processors.auth',
                    'django.contrib.messages.context_processors.messages',
                ],
                'libraries': {
                }
            },
        },
    ]

    WSGI_APPLICATION = 'studio.wsgi.application'
    ASGI_APPLICATION = 'studio.asgi.application'

    # Database
    # https://docs.djangoproject.com/en/2.2/ref/settings/#databases

    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.postgresql_psycopg2',
            'NAME': '{{ .Values.postgresql.global.postgresql.auth.database }}',
            'USER': '{{ .Values.postgresql.global.postgresql.auth.username }}',
            'PASSWORD': os.environ.get('POSTGRES_PASSWORD'),
            'HOST': '{{ .Values.postgresql.fullnameOverride }}',
            'PORT': '{{ .Values.postgresql.primary.service.ports.postgresql }}',
        }
    }

    # Password validation
    # https://docs.djangoproject.com/en/2.2/ref/settings/#auth-password-validators

    AUTH_PASSWORD_VALIDATORS = [
        {
            'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
        },
        {
            'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        },
        {
            'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
        },
        {
            'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
        },
    ]

    # Internationalization
    # https://docs.djangoproject.com/en/2.2/topics/i18n/
    LANGUAGE_CODE = 'en-us'
    TIME_ZONE = 'UTC'
    USE_I18N = True
    USE_L10N = True
    USE_TZ = True

    # Media Files for Studio apps
    #MEDIA_URL = {{ .Values.studio.media.mount_path | quote }}
    #MEDIA_ROOT = {{ .Values.studio.media.mount_path | quote }}

    #From studio
    MEDIA_URL = '/media/'
    MEDIA_ROOT = os.path.join(BASE_DIR, 'media/')

    # Related to user registration and authetication workflow
    LOGIN_REDIRECT_URL = '/projects'
    LOGIN_URL = 'login'
    LOGOUT_URL = 'logout'
    INACTIVE_USERS = {{ if .Values.studio.inactive_users }}True{{ else }}False{{ end }}

    # Specific to Studio stack:
    VERSION_BACKEND = 'studio.version.Version'

    # Other Helm/k8s deployment settings
    CHART_FOLDER = "/app/charts/apps"
    EXTERNAL_KUBECONF = True
    KUBECONFIG = "/app/kubeconfig/config" # Deprecated, uses ServiceAccount instead
    NAMESPACE = {{ .Values.namespace | default "default" | quote }}
    KUBE_API_REQUEST_TIMEOUT = {{ .Values.studio.kube_api_request_timeout }}
    STORAGECLASS = {{ include "stackn.studio.storageclass" . | quote }}
    
    # App dependencies

    # Apps
    APPS_MODEL = "apps.Apps"
    APPINSTANCE_MODEL = "apps.AppInstance"
    APPCATEGORIES_MODEL ="apps.AppCategories"

    # Models
    MODELS_MODEL = "models.Model"

    # Projects
    PROJECTS_MODEL = "projects.Project"
    PROJECTLOG_MODEL = "projects.ProjectLog"
    ENVIRONMENT_MODEL = "projects.Environment"
    RELEASENAME_MODEL = "projects.ReleaseName"

    # App statuses
    APPS_STATUS_SUCCESS = ['Running', 'Succeeded', 'Success']
    APPS_STATUS_WARNING = ['Pending', 'Installed',
                        'Waiting', 'Installing', 'Created', 'ContainerCreating']

    DOMAIN = {{ .Values.domain | quote }}
    GRPC_DOMAIN = {{ .Values.grpc_domain | quote }}
    AUTH_DOMAIN = '{{ .Release.Name }}-studio.{{ .Values.namespace | default "default" }}.svc.{{ .Values.cluster_domain | default "cluster.local"}}'
    AUTH_PROTOCOL = 'http'
    STUDIO_URL = 'http://{{ .Release.Name }}-studio:8080'
    # To enable sticky sessions for k8s ingress
    SESSION_COOKIE_DOMAIN = {{ .Values.session_cookie_domain | quote }}
    CSRF_TRUSTED_ORIGINS = ['https://*{{ .Values.session_cookie_domain }}','https://*.127.0.0.1'] + [{{ .Values.studio.csrf_trusted_origins | quote}}]

    # Email
    {{ if .Values.studio.emailService.enabled }}
    EMAIL_HOST = {{ .Values.studio.emailService.host | quote}}
    EMAIL_PORT = {{ .Values.studio.emailService.port }}
    EMAIL_HOST_USER = os.environ["EMAIL_HOST_USER"]
    EMAIL_HOST_PASSWORD = os.environ["EMAIL_HOST_PASSWORD"]
    EMAIL_USE_TLS = True

    EMAIL_DOMAIN_NAME = {{ .Values.studio.emailService.domainName | quote}}
    EMAIL_API_KEY = os.environ["EMAIL_API_KEY"]
    EMAIL_MAILGUN_API = {{ .Values.studio.emailService.apiEndpoint | quote}}
    EMAIL_NOTIFY_ON_ACCOUNT_REGISTER_LIST = [{{- range .Values.studio.emailService.notifyOnAccountRegisterList }}{{. | quote }},{{- end }}]
    DEFAULT_FROM_EMAIL = {{ .Values.studio.emailService.smtpEmailFrom | quote}}
    {{ else }}
    EMAIL_BACKEND = "django.core.mail.backends.filebased.EmailBackend"
    EMAIL_FILE_PATH =  os.path.join(BASE_DIR, 'sent_emails')
    {{ end }}
    EMAIL_TEMPLATE_PROTOCOL = "https"

    VERSION = {{ .Values.studio.version | quote  }}

    MIGRATION_MODULES = {
        'apps': 'studio.migrations.apps',
        'projects': 'studio.migrations.projects',
        'system': 'studio.migrations.system'
    }

    {{ if .Values.studio.custom_migrations.enabled }}
    {{- range $key, $value := .Values.studio.custom_migrations.apps }}
    MIGRATION_MODULES[{{$key | quote }}] = {{$value | quote }}
    {{- end }}
    {{- end }}

    # Defines how many apps a user is allowed to create within one project
    APPS_PER_PROJECT_LIMIT = {
        "vscode": 1,
        "volumeK8s": 5,
        "pytorch-serve": 1,
        "tensorflow-serve": 1,
        "mlflow-serve": 1,
        "mlflow": 1,
        "minio": 1,
        "jupyter-lab": 1,
        "mongo-express": 1,
        "reducer": 1,
        "docker-registry": 1,
        "combiner": 2,
        "mongodb": 1,
    }

    PROJECTS_PER_USER_LIMIT = 3

    STUDIO_ACCESSMODE = os.environ.get("STUDIO_ACCESSMODE", "")
    {{ if .Values.studio.enable_project_extra_settings }}
    ENABLE_PROJECT_EXTRA_SETTINGS = True
    {{ else }}
    ENABLE_PROJECT_EXTRA_SETTINGS = False
    {{ end }}
    {{ if .Values.studio.disabledAppInstanceFields.enabled }}
    DISABLED_APP_INSTANCE_FIELDS = [{{- range .Values.studio.disabledAppInstanceFields.fields }}{{. | quote }},{{- end }}]
    {{- end }}
    FEDN_LOCAL_CONTROLLER = os.environ.get("FEDN_LOCAL_CONTROLLER", None)

    DISCORD_ALERT_ON_NEW_USER = {{ if .Values.studio.discord.alert_on_new_user }}True{{ else }}False{{ end }}
    DISCORD_ALTERT_WEBHOOK_URL = {{ .Values.studio.discord.alert_webhook_url | quote }}
    DISCORD_ALERT_ON_NEW_USER_MESSAGE = {{ .Values.studio.discord.alert_on_new_user_message | quote }}

    # Argo CD API URL and Token
    ARGO_CD_ENABLED = os.environ.get("ARGO_CD_ENABLED", False)
    ARGO_CD_API_URL = os.environ.get("ARGO_CD_API_URL", None)
    ARGO_CD_TOKEN = os.environ.get("ARGO_CD_TOKEN", None)
    S3HOST = os.environ.get("S3HOST", "minio-fedn")
    S3PORT = os.environ.get("S3PORT", "9000")
    S3SECRET_NAME = os.environ.get("S3SECRET_NAME", "minio-fedn")
