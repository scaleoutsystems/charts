apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    reloader.stakater.com/auto: "true"
  labels:
    io.kompose.service: {{ .Release.Name }}-studio
    name: {{ .Release.Name }}-studio
  name: {{ .Release.Name }}-studio
spec:
  replicas: {{ .Values.studio.replicas }}
  strategy:
    type: {{ .Values.studio.strategy.type }}
  selector:
    matchLabels:
      name: {{ .Release.Name }}-studio
  template:
    metadata:
      labels:
        io.kompose.service: {{ .Release.Name }}-studio
        name: {{ .Release.Name }}-studio
        web: studio-web
        app: stackn-studio
        allow-api-access: "true"
        networking/allow-internet-egress: "true"
    spec:
      automountServiceAccountToken: false
      securityContext:
        fsGroup: {{ .Values.studio.securityContext.fsGroup }}
      initContainers:
        - name: wait-for-db
          image: postgres
          {{ if .Values.studio.cloudnativepg.enabled }}
          env:
          - name: POSTGRES_PORT
            valueFrom:
              secretKeyRef:
                name: {{ .Values.studio.cloudnativepg.clusterName }}-app
                key: port
          - name: POSTGRES_HOST
            valueFrom:
              secretKeyRef:
                name: {{ .Values.studio.cloudnativepg.clusterName }}-app
                key: host
          command: ['sh', '-c', 'until pg_isready --host=$POSTGRES_HOST --port=$POSTGRES_PORT; do echo waiting for database; sleep 2; done;']
          {{ else }}
          command: ['sh', '-c', 'until pg_isready --host={{ .Values.postgresql.fullnameOverride }} --port={{ .Values.postgresql.primary.service.ports.postgresql }}; do echo waiting for database; sleep 2; done;']
          {{ end }}
          resources:
            limits:
              cpu: "100m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "512Mi"
      containers:
      - args:
        - sh
        - scripts/run_web.sh
        ports:
        - containerPort: 8080
        envFrom:
        - configMapRef:
            name: {{ .Release.Name }}-studio-envs
        env:
        {{ if .Values.studio.jwt_auth.existingSecret }}
        - name: SIGNING_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.studio.jwt_auth.existingSecret }}
              key: private_key
        {{ end }}
        - name: DJANGO_SUPERUSER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.secretName" . }}
              key: studio-superuser-password
        - name: EVENT_LISTENER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.secretName" . }}
              key: studio-event-listener-user-password
        {{ if .Values.studio.cloudnativepg.enabled }}
        - name: POSTGRES_NAME
          valueFrom:
            secretKeyRef:
              name: {{ .Values.studio.cloudnativepg.clusterName }}-app
              key: dbname
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: {{ .Values.studio.cloudnativepg.clusterName }}-app
              key: user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.studio.cloudnativepg.clusterName }}-app
              key: password
        - name: POSTGRES_PORT
          valueFrom:
            secretKeyRef:
              name: {{ .Values.studio.cloudnativepg.clusterName }}-app
              key: port
        - name: POSTGRES_HOST
          valueFrom:
            secretKeyRef:
              name: {{ .Values.studio.cloudnativepg.clusterName }}-app
              key: host 
        {{ else }}
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.postgres.secretName" . }}
              key: password
        {{ end }}
        - name: DJANGO_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.secretName" . }}
              key: django-secret-key
        {{ if .Values.studio.emailService.enabled }}
        - name: EMAIL_HOST_USER
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.secretName" . }}
              key: email-host-user
        - name: EMAIL_HOST_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.secretName" . }}
              key: email-host-password
        - name: EMAIL_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.secretName" . }}
              key: email-api-key
        {{ end }}
        - name: S3ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.studio.minio.secretName }}
              key: CONSOLE_ACCESS_KEY
        - name: S3SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.studio.minio.secretName }}
              key: CONSOLE_SECRET_KEY
        {{ if .Values.studio.argocd.enabled }}
        - name: ARGO_CD_TOKEN
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.secretName" . }}
              key: studio-argocd-token
        {{ end }}
        {{ if .Values.mongodb.enabled }}
        - name: MONGO_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "mongodb.fullname" .Subcharts.mongodb }}
              key: mongodb-root-password
        {{ end }}
        {{ if .Values.studio.harbor.enabled }}
        - name: HARBOR_CREDS
          valueFrom:
            secretKeyRef:
              name: {{ include "stackn.secretName" . }}
              key: harbor-creds
        {{ end }}
        image: {{ .Values.studio.image.repository }}
        imagePullPolicy: {{ .Values.studio.image.pullPolicy }}
        name: {{ .Release.Name }}-studio
        resources:
          limits:
            cpu: {{ .Values.studio.resources.limits.cpu }}
            memory: {{ .Values.studio.resources.limits.memory }}
          requests:
            cpu: {{ .Values.studio.resources.requests.cpu }}
            memory: {{ .Values.studio.resources.requests.memory }}
        {{- if .Values.studio.securityContext.enabled }}
        securityContext:
          runAsUser: {{ .Values.studio.securityContext.runAsUser }}
          runAsGroup: {{ .Values.studio.securityContext.runAsGroup }}
          allowPrivilegeEscalation: {{ .Values.studio.securityContext.allowPrivilegeEscalation }}
          privileged: {{ .Values.studio.securityContext.privileged }}
          capabilities:
            drop:
              - all
        {{- end }}
        {{- if .Values.studio.readinessProbe.enabled }}
        readinessProbe:
          tcpSocket:
            port: {{ .Values.studio.readinessProbe.tcpSocket.port }}
          initialDelaySeconds: {{ .Values.studio.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.studio.readinessProbe.periodSeconds }}
        {{- end }}
        {{- if .Values.studio.livenessProbe.enabled }}
        livenessProbe:
          tcpSocket:
            port: {{ .Values.studio.livenessProbe.tcpSocket.port }}
          initialDelaySeconds: {{ .Values.studio.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.studio.livenessProbe.periodSeconds }}
        {{- end }}
      imagePullSecrets:
        - name: {{ .Values.imagePullSecrets.name }}
      restartPolicy: Always
